<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Issuance System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        body {
            overflow: hidden;
        }

        /* Sidebar Hover Effect */
        .sidebar-item {
            transition: background 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(10px);
        }

        /* Dropdown Menu - Show on Hover */
        .dropdown:hover .dropdown-menu {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Smooth Dropdown Animation */
        .animate-dropdown {
            visibility: hidden;
            opacity: 0;
            transform: translateY(-5px);
            transition: visibility 0s linear 0.3s, opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .dropdown:hover .animate-dropdown {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0s;
        }

        /* animate BSCIMS */
        .animated-title {
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .animated-title:hover {
            transform: scale(1.1);
            color: #eff319;
        }

        .col-6 {
            font-family: 'Times New Roman', Times, serif;
        }

        .times-new-roman {
            font-family: 'Times New Roman', Times, serif;
        }

      /* Print styles for long bond paper (8.5" x 13") */
@media print {
    @page {
        size: 8.5in 13in; /* Long bond paper size */
        margin: 0.75in 1in; /* Top/bottom: 0.75", Left/right: 1" */
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    body {
        margin: 0;
        padding: 0;
        font-size: 12pt;
        line-height: 1.4;
    }
    
    /* Hide everything except the certificate modal content */
    body * {
        visibility: hidden;
    }
    
    /* Show only the modal and its contents */
    .modal.show,
    .modal.show *,
    .modal-dialog,
    .modal-dialog *,
    .modal-content, 
    .modal-content *,
    .certificate-print,
    .certificate-print * {
        visibility: visible;
    }
    
    /* Position modal content for print */
    .modal.show {
        position: static !important;
        display: block !important;
        background: none !important;
    }
    
    .modal-dialog {
        position: static !important;
        margin: 0 !important;
        max-width: none !important;
        width: 100% !important;
        height: 100% !important;
        transform: none !important;
    }
    
    .modal-content {
        position: static !important;
        border: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        background: white !important;
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .modal-header,
    .modal-footer,
    .btn,
    button,
    .badge,
    [class*="btn"],
    .close,
    .modal-title {
        display: none !important;
    }
    
    /* Hide specific action buttons */
    .btn-success,
    .btn-danger,
    .btn-info,
    .btn-primary,
    .btn-warning {
        display: none !important;
    }
    
    .modal-body {
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
        height: 100% !important;
    }
    
    /* Certificate content styling for print */
    .certificate-print {
        position: static !important;
        width: 100% !important;
        height: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        page-break-inside: avoid;
        font-family: 'Times New Roman', serif;
    }
}

/* Screen preview styles for the modal */
.certificate-preview {
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
    padding: 20px;
    
    min-height: 500px;
}

/* Certificate styling */
.certificate-header {
    margin-bottom: 30px;
}

.certificate-header h4 {
    margin: 5px 0;
    font-size: 14px;
}

.certificate-logos {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20px 0;
}

.certificate-title {
    font-size: 48px;
    font-weight: bold;
    margin: 30px 0;
    letter-spacing: 3px;
}

.certificate-content {
    margin: 40px 0;
    font-size: 16px;
    line-height: 1.8;
}

.certificate-name {
    font-weight: bold;
    text-decoration: underline;
    font-size: 20px;
    margin: 10px 0;
}

.certificate-purpose {
    font-style: italic;
    margin: 20px 0;
}

/* Print button styling */
.print-certificate-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.print-certificate-btn:hover {
    background: #0056b3;
}

@media print {
    .print-certificate-btn {
        display: none !important;
    }
}

/* Modal specific adjustments */
.modal-dialog {
    max-width: 90%;
    margin: 30px auto;
}

.modal-body {
    padding: 0;
}





        .editable {
           
            padding: 2px 4px;
            cursor: text;
        }

        .editable:hover {
            background-color: #f8f9fa;
        }

        .loading-spinner {
            display: none;
        }

        .certificate-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .certificate-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }

        .stat-icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #6cd885; /* green */
    color: #fff; /* white text */
    text-align: center;
    border-radius: 8px;
    padding: 16px;
    position: fixed;
    z-index: 999;
    top: 20px;
    right: 20px;
    font-size: 17px;
    opacity: 0;
    transition: opacity 0.5s, top 0.5s;
}

.toast.show {
    visibility: visible;
    opacity: 1;
    top: 65px;
}

/* Add this CSS rule to remove borders when printing */
@media print {
    .certificate-preview {
        border: none !important;
    }
    
    .certificate-print {
        border: none !important;
    }
}

/* Notification Badge Styles */
        .notification-badge {
            position: absolute;
            top: 8px;
            right: 10px;
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            animation: pulse-notification 2s infinite;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);
        }

        @keyframes pulse-notification {
            0% { transform: scale(1); box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 4px 12px rgba(255, 71, 87, 0.6); }
            100% { transform: scale(1); box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4); }
        }

        /* Hide badge when count is 0 */
        .notification-badge.hidden {
            display: none;
        }

        /* Additional styles for new request indicator */
        .new-request-glow {
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.3);
            border-left: 3px solid #ff4757;
        }

        .content-area {
            margin-left: 235px;
            padding: 20px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
        }

        /* Active page indicator styles - grey theme */
.sidebar-item.active {
    background: linear-gradient(135deg, #6e6e6e 0%, #6e6e6e 100%);
    
    border-left: 4px solid #eff1f1; /* Accent color */
    transform: translateX(8px);
    color: #fff !important;
}       

        .sidebar-item.active::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 8px solid #eef1f3;
        }

        .animated-title {
            animation: pulse 2s infinite;
            font-weight: bold;
            color: #fff;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .dropdown-menu {
            background-color: #2c3138;
            border: 1px solid #495057;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .dropdown-item {
            color: #fff;
            transition: all 0.3s ease;
            position: relative;
        }

        .dropdown-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: translateX(5px);
        }

        .dropdown-item.active {
            background: linear-gradient(135deg, #6e6e6e 0%, #6e6e6e 100%);
            color: #fff;
            
        }

        .animate-dropdown {
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse-notification {
            0% { transform: scale(1); box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 4px 12px rgba(255, 71, 87, 0.6); }
            100% { transform: scale(1); box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4); }
        }

        .new-request-glow {
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.3);
            border-left: 3px solid #ff4757;
        }

        /* Content area styles */
        .content-area {
            margin-left: 235px;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* Page indicator styles for different sections */
        .page-indicator {
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-item.active .page-indicator {
            opacity: 1;
        }

        /* Glow effect for active items */
        .sidebar-item.active {
            position: relative;
            overflow: visible;
        }

       
    </style>
</head>

<body class="bg-light">
    <div class="d-flex">
        <!-- Sidebar -->
        <nav class="sidebar text-white vh-100 p-3" style="width: 235px; background-color: #31363F;">
            <div class="mb-4" style="margin-left: 19px;">
                <h2 class="fs-4 animated-title">BSCIMS</h2>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item mb-3" style="margin-top: 30px;">
                    <a href="dashboard.php" class="nav-link text-white d-flex align-items-center sidebar-item">
                        <i class="fas fa-home me-2"></i> Main Dashboard
                    </a>
                </li>

                <li class="nav-item dropdown mb-3">
                    <a href="#" id="officialsBtn" class="nav-link text-white d-flex align-items-center sidebar-item dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-users me-2"></i> Barangay Officials
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="Barangay_official.php">View Officials</a></li>
                        <li><a class="dropdown-item" href="manage_official.html">Manage Officials</a></li>
                    </ul>
                </li>

                <li class="nav-item mb-3 dropdown">
                    <a class="nav-link dropdown-toggle text-white d-flex align-items-center sidebar-item" href="#" role="button">
                        <i class="fas fa-user-friends me-2"></i> Barangay Residents
                    </a>
                    <ul class="dropdown-menu animate-dropdown">
                        <li><a class="dropdown-item" href="Residents.html">Register Residents</a></li>
                        <li><a class="dropdown-item" href="view_residents.php">Registered Residents</a></li>
                    </ul>
                </li>

               <!-- ENHANCED CITIZEN REQUESTS WITH NOTIFICATION -->
            <li class="nav-item mb-3 dropdown">
                <a class="nav-link dropdown-toggle text-white d-flex align-items-center sidebar-item" id="citizen-requests-link" data-page="citizen-requests">
                    <i class="fas fa-file-alt me-2"></i> Citizen Requests
                   
                    <!-- Notification Badge -->
                    <span class="notification-badge" id="request-notification-badge">0</span>
                     <div class="page-indicator"></div>
                </a>
                <ul class="dropdown-menu animate-dropdown">
                    <li><a class="dropdown-item" href="Request_Documents.php" >Request Documents</a></li>
                    <li>
                        <a class="dropdown-item d-flex align-items-center justify-content-between" href="Issued Certificate.html" data-page="certificate-issuance">
                            Certificate Issuance
                            <span class="badge bg-danger ms-2" id="pending-requests-mini-badge" style="display: none;">0</span>
                        </a>
                    </li>
                </ul>
            </li>

                <li class="nav-item mb-3">
                    <a class="nav-link text-white d-flex align-items-center sidebar-item" href="Administration.php">
                        <i class="fas fa-building me-2"></i> Administration
                    </a>
                </li>

                <li class="nav-item mb-3">
                    <a href="Announcement.html" class="nav-link text-white d-flex align-items-center sidebar-item">
                        <i class="fas fa-bullhorn me-2"></i> Announcements
                    </a>
                </li>

                <li class="nav-item mb-3">
                    <a href="list_admins.php" class="nav-link text-white d-flex align-items-center sidebar-item">
                        <i class="fas fa-cog me-2"></i> System Settings
                    </a>
                </li>

                <li class="nav-item mb-3">
                    <a class="nav-link text-white d-flex align-items-center sidebar-item" href="request_reports.php">
                        <i class="fas fa-chart-bar me-2"></i> Reports
                    </a>
                </li>

                <li class="nav-item mt-auto">
                    <a href="logout.php" class="nav-link text-white d-flex align-items-center sidebar-item">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="flex-grow-1 p-4" style="margin-left: -26px; margin-right: -15px; margin-top: -24px; overflow-y: auto; height: 100vh;">
            <!-- Header -->
            <div class="d-flex align-items-center text-white p-3" style="background-color: #222831; margin-right: -10px; border-radius: 0px; ">
                <img src="logo.png" alt="Logo" style="width: 30px; height: 30px; margin-right: 10px;">
                <h1 class="fs-5 mb-0">Barangay San Carlos, City of Valencia, Province of Bukidnon</h1>
            </div>
            
            
            <!-- Main Content Area -->
            <div class="container-fluid mt-4" >
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="mb-3" style="margin-top: 50px;">
                            <i class="fas fa-certificate text-primary me-2"></i>
                            Certificate Issuance System
                        </h2>
                        <p class="text-muted">Manage and issue certificates for Barangay San Carlos residents</p>
                    </div>
                    
                </div>
       
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card text-center">
                            <div class="card-body">
                                <i class="fas fa-file-alt stat-icon"></i>
                                <h3 class="mt-2" id="totalRequests">0</h3>
                                <p class="mb-0">Total Requests</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card stat-card text-center">
                            <div class="card-body">
                                <i class="fas fa-clock stat-icon text-warning"></i>
                                <h3 class="mt-2" id="pendingRequests">0</h3>
                                <p class="mb-0">Pending</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card stat-card text-center">
                            <div class="card-body">
                                <i class="fas fa-check-circle stat-icon text-success"></i>
                                <h3 class="mt-2" id="approvedRequests">0</h3>
                                <p class="mb-0">Approved</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card text-center">
                            <div class="card-body">
                                <i class="fas fa-certificate stat-icon text-info"></i>
                                <h3 class="mt-2" id="issuedCertificates">0</h3>
                                <p class="mb-0">Issued</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Certificate Selection Panel -->
                    <div class="col-md-4">
                        <div class="card certificate-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>Certificate Selection
                                </h5>
                            </div>

                            <div class="card-body">
                               <div class="mb-3">
    <label for="certificateTypeSelect" class="form-label">Select Certificate Type</label>
    <select class="form-select" id="certificateTypeSelect" onchange="loadCertificateRequests()">
        <option value="">-- Select Certificate Type --</option>
    </select>
</div>




                                <div class="mb-3">
                                    <label for="statusFilter" class="form-label">Filter by Status</label>
                                    <select class="form-select" id="statusFilter" onchange="filterRequests()">
                                        <option value="">All Status</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Issued">Issued</option>
                                        <option value="Rejected">Rejected</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="searchInput" class="form-label">Search Requests</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchInput" placeholder="Search by name or request ID..." onkeyup="searchRequests()">
                                        <button class="btn btn-outline-secondary" type="button">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>

                                <button class="btn btn-success w-100" onclick="refreshData()">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh Data
                                </button>
                               
                            </div>
                            
                            </div> 
                               <button onclick="window.location.href='Cerificate_template_editor.php'" class="btn btn-success" style="margin-left: 50px;;">
                                    <i class="fas fa-edit me-1"></i> Certificate Template Editor
                               </button>
                            </div>

                    <!-- Request List Panel -->
                    <div class="col-md-8">
                        <div class="card certificate-card">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-list-ul me-2"></i>Certificate Requests
                                </h5>
                                <div class="loading-spinner">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="table-dark sticky-top">
                                            <tr>
                                                <th>Request ID</th>
                                                <th>Resident Name</th>
                                                <th>Purpose</th>
                                                <th>Signatory</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="requestsTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted py-4">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    Select a certificate type to view requests
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Certificate Preview Modal -->
    <div class="modal fade" id="certificateModal" tabindex="-1" aria-labelledby="certificateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white no-print">
                    <h5 class="modal-title" id="certificateModalLabel">Certificate Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 no-print d-flex justify-content-between align-items-center">
                        
                        <div>
                            <button type="button" class="btn btn-sm btn-success" onclick="updateStatus('Approved')" id="approveBtn">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="updateStatus('Rejected')" id="rejectBtn">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <button type="button" class="btn btn-sm btn-info" onclick="updateStatus('Issued')" id="issueBtn">
                                <i class="fas fa-certificate"></i> Mark as Issued
                            </button>
                        </div>
                    </div>
                    
                    <div id="certificatePreview" class="certificate-preview p-4 border certificate-print">
                        <!-- Certificate content will be populated here -->
                    </div>
                </div>
                <div class="modal-footer no-print">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printCertificate()">
                        <i class="fas fa-print"></i> Print Certificate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalLabel">Update Request Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="statusForm">
                        <div class="mb-3">
                            <label for="statusNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="statusNotes" rows="3" placeholder="Add any notes or comments..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmStatusUpdate()">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Data refreshed successfully!</div>
<div id="certificatePreview" class="certificate-preview p-4 certificate-print"></div>
    
<div id="certificateModalContainer"></div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentRequestData = null;
        let currentStatus = '';
        let isEditMode = true;
        let allRequests = [];

        

        // Initialize the page
        document.addEventListener("DOMContentLoaded", function() {
            loadStatistics();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Edit mode toggle
            document.getElementById('editModeBtn').addEventListener('click', function() {
                isEditMode = true;
                toggleEditMode();
            });

            document.getElementById('saveModeBtn').addEventListener('click', function() {
                isEditMode = true;
                toggleEditMode();
                alert('Changes saved successfully!');
            });
        }

        // Load statistics
        function loadStatistics() {
            fetch('get_certificate_stats.php')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('totalRequests').textContent = data.data.total || 0;
                        document.getElementById('pendingRequests').textContent = data.data.pending || 0;
                        document.getElementById('approvedRequests').textContent = data.data.approved || 0;
                        document.getElementById('issuedCertificates').textContent = data.data.issued || 0;
                    }
                })
                .catch(error => console.error('Error loading statistics:', error));
        }

        // Load certificate requests based on type
        function loadCertificateRequests() {
            const certificateType = document.getElementById('certificateTypeSelect').value;
            const tableBody = document.getElementById('requestsTableBody');
            
            if (!certificateType) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-info-circle me-2"></i>
                            Select a certificate type to view requests
                        </td>
                    </tr>
                `;
                return;
            }

            // Show loading spinner
            document.querySelector('.loading-spinner').style.display = 'block';

            fetch('get_certificate_requests.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `certificate_type=${encodeURIComponent(certificateType)}`
            })
            .then(response => response.json())
            .then(data => {
                document.querySelector('.loading-spinner').style.display = 'none';
                
                if (data.status === 'success') {
                    allRequests = data.data;
                    displayRequests(allRequests);
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error: ${data.message}
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                document.querySelector('.loading-spinner').style.display = 'none';
                console.error('Error:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading requests
                        </td>
                    </tr>
                `;
            });
        }

        // Display requests in table
        function displayRequests(requests) {
            const tableBody = document.getElementById('requestsTableBody');
            
            if (requests.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-folder-open me-2"></i>
                            No requests found for this certificate type
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = requests.map(request => {
                const statusClass = getStatusClass(request.status);
                const actionButtons = getActionButtons(request);
                
                return `
                    <tr>
                        <td><span class="badge bg-secondary">${request.request_id}</span></td>
                        <td><strong>${request.resident_name}</strong></td>
                        <td>${request.purpose}</td>
                        <td>${request.signatory}</td>
                        <td><span class="badge ${statusClass}">${request.status}</span></td>
                        <td>${formatDate(request.request_date)}</td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            }).join('');
        }

        // Get status class for badge
        function getStatusClass(status) {
            switch(status) {
                case 'Pending': return 'bg-warning';
                case 'Approved': return 'bg-success';
                case 'Issued': return 'bg-info';
                case 'Rejected': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // Get action buttons based on status
        function getActionButtons(request) {
            return `
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-primary" onclick="viewCertificate('${request.id}')" title="View Certificate">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-info" onclick="editRequest('${request.id}')" title="Edit Request">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteRequest('${request.id}')" title="Delete Request">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + '<br><small class="text-muted">' + date.toLocaleTimeString() + '</small>';
        }

        // View certificate
        function viewCertificate(requestId) {
            const request = allRequests.find(r => r.id == requestId);
            if (!request) return;

            currentRequestData = request;
            populateCertificate(request);
            
            const modal = new bootstrap.Modal(document.getElementById('certificateModal'));
            modal.show();
        }

       
        // Get certificate content based on type
        function getCertificateContent(certType) {
            switch(certType) {
                case 'Certificate of Residency':
                    return 'THIS IS TO FURTHER CERTIFY that the above-named person is a bonafide resident of this barangay and has been residing here for a considerable period of time.';
                case 'Certificate of Indigency':
                    return 'THIS IS TO FURTHER CERTIFY that the above-named person belongs to the indigent family of this barangay and is in need of financial assistance.';
                case 'Barangay Clearance':
                    return 'THIS IS TO FURTHER CERTIFY that as far as this Office is concerned as of this date, the above named person has no criminal record or pending charge for any violation or infraction of rules or regulations, ordinances and laws.';
                case 'Barangay Certification':
                    return 'THIS CERTIFICATION is issued to attest to the good moral character and standing of the above-named person in this community.';
                case 'Business Permit':
                   return 'THIS IS TO CERTIFY that the above-named business establishment has complied with all barangay requirements and is hereby permitted to operate within this jurisdiction.';
                default:
                    return 'THIS CERTIFICATION is issued for whatever legal purpose it may serve.';
            }
        }

        

        // Update request status
        function updateStatus(status) {
            if (!currentRequestData) return;
            
            currentStatus = status;
            document.getElementById('statusModalLabel').textContent = `Update Status to ${status}`;
            
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }

        // Confirm status update
        function confirmStatusUpdate() {
            if (!currentRequestData || !currentStatus) return;
            
            const notes = document.getElementById('statusNotes').value;
            
            fetch('update_request_status.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `request_id=${currentRequestData.id}&status=${currentStatus}&notes=${encodeURIComponent(notes)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`Request status updated to ${currentStatus} successfully!`);
                    bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
                    bootstrap.Modal.getInstance(document.getElementById('certificateModal')).hide();
                    loadCertificateRequests();
                    loadStatistics();
                } else {
                    alert('Error updating status: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating status. Please try again.');
            });
        }

        // Edit request
        function editRequest(requestId) {
            const request = allRequests.find(r => r.id == requestId);
            if (!request) return;
            
            // You can implement a more sophisticated edit modal here
            const newPurpose = prompt('Edit Purpose:', request.purpose);
            if (newPurpose && newPurpose !== request.purpose) {
                updateRequestField(requestId, 'purpose', newPurpose);
            }
        }

        // Update request field
        function updateRequestField(requestId, field, value) {
            fetch('update_request_field.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `request_id=${requestId}&field=${field}&value=${encodeURIComponent(value)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Request updated successfully!');
                    loadCertificateRequests();
                } else {
                    alert('Error updating request: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating request. Please try again.');
            });
        }

        // Delete request
        function deleteRequest(requestId) {
            if (!confirm('Are you sure you want to delete this request? This action cannot be undone.')) {
                return;
            }
            
            fetch('delete_request.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `request_id=${requestId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Request deleted successfully!');
                    loadCertificateRequests();
                    loadStatistics();
                } else {
                    alert('Error deleting request: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting request. Please try again.');
            });
        }

        // Filter requests by status
        function filterRequests() {
            const statusFilter = document.getElementById('statusFilter').value;
            let filteredRequests = allRequests;
            
            if (statusFilter) {
                filteredRequests = allRequests.filter(request => request.status === statusFilter);
            }
            
            displayRequests(filteredRequests);
        }

        // Search requests
        function searchRequests() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filteredRequests = allRequests;
            
            if (searchTerm) {
                filteredRequests = allRequests.filter(request => 
                    request.resident_name.toLowerCase().includes(searchTerm) ||
                    request.request_id.toLowerCase().includes(searchTerm) ||
                    request.purpose.toLowerCase().includes(searchTerm)
                );
            }
            
            displayRequests(filteredRequests);
        }

        // Print certificate
        function printCertificate() {
            window.print();
        }

       function refreshData() {
    loadStatistics();
    loadCertificateRequests();
    showToast('Data refreshed successfully!');
}

function showToast(message) {
    var toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = "toast show";
    setTimeout(function() {
        toast.className = toast.className.replace("show", "");
    }, 3000); // toast disappears after 3 seconds
}


        // Auto-refresh every 30 seconds
        setInterval(function() {
            if (document.getElementById('certificateTypeSelect').value) {
                loadCertificateRequests();
            }
            loadStatistics();
        }, 30000);

        // Handle modal cleanup
        document.getElementById('certificateModal').addEventListener('hidden.bs.modal', function () {
            currentRequestData = null;
            isEditMode = false;
            toggleEditMode();
        });

        document.getElementById('statusModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('statusNotes').value = '';
            currentStatus = '';
        });
    </script>

    <script>
document.addEventListener("DOMContentLoaded", function () {
    fetch("get_certificate_types.php")
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById("certificateTypeSelect");
            data.forEach(certificate => {
                const option = document.createElement("option");
                option.value = certificate;
                option.textContent = certificate;
                select.appendChild(option);
            });
        })
        .catch(error => console.error("Error loading certificate types:", error));
});
</script>

<script>
    // Add this script to fix the header scrolling issue
document.addEventListener("DOMContentLoaded", function() {
    // Remove overflow hidden from body
    document.body.style.overflow = '';
    
    // Get the header element
    const header = document.querySelector('.d-flex.align-items-center.text-white.p-3');
    
    // Make header fixed
    if (header) {
        header.style.position = 'fixed';
        header.style.top = '0';
        header.style.left = '235px'; // Width of sidebar
        header.style.right = '0';
        header.style.zIndex = '1000';
        header.style.width = 'calc(100% - 235px)';
    }
    
    // Get the main content container
    const mainContent = document.querySelector('.container-fluid.mt-4');
    
    // Add top margin to account for fixed header
    if (mainContent) {
        mainContent.style.marginTop = '80px';
        mainContent.style.paddingTop = '1rem';
    }
    
    // Ensure the flex-grow-1 div can scroll properly
    const flexGrowDiv = document.querySelector('.flex-grow-1');
    if (flexGrowDiv) {
        flexGrowDiv.style.height = '100vh';
        flexGrowDiv.style.overflowY = 'auto';
    }
});


</script>


<script>
    // Certificate template storage and management
let certificateTemplates = {};

// Load saved templates from localStorage on page load
function loadSavedTemplates() {
    try {
        const saved = localStorage.getItem('certificateTemplates');
        if (saved) {
            certificateTemplates = JSON.parse(saved);
        }
    } catch (error) {
        console.error('Error loading saved templates:', error);
        certificateTemplates = {};
    }
}

// Save templates to localStorage
function saveTemplatesToStorage() {
    try {
        localStorage.setItem('certificateTemplates', JSON.stringify(certificateTemplates));
        console.log('Templates saved to localStorage');
    } catch (error) {
        console.error('Error saving templates:', error);
    }
}

// Get template key for certificate type
function getTemplateKey(certificateType) {
    return certificateType.replace(/\s+/g, '_').toLowerCase();
}

// Enhanced populateCertificate function with template loading
function populateCertificate(request) {
    document.getElementById('certificateModalLabel').textContent = request.certificate_type + ' Preview';
    
    const certificatePreview = document.getElementById('certificatePreview');
    const templateKey = getTemplateKey(request.certificate_type);
    
    // Check if we have a saved template for this certificate type
    const savedTemplate = certificateTemplates[templateKey];
    
    let certificateContent;
    
    if (savedTemplate) {
        // Use saved template and replace dynamic data
        certificateContent = applySavedTemplate(savedTemplate, request);
    } else {
        // Use default template
        certificateContent = getDefaultTemplate(request);
    }
    
    certificatePreview.innerHTML = certificateContent;
}

// Apply saved template with current request data
function applySavedTemplate(template, request) {
    let content = template.content;
    
    // Replace dynamic placeholders with actual data
    const replacements = {
        '{{RESIDENT_NAME}}': request.resident_name,
        '{{CERTIFICATE_TYPE}}': request.certificate_type,
        '{{PURPOSE}}': request.purpose,
        '{{REQUEST_DATE}}': formatDate(request.request_date).split('<br>')[0],
        '{{SIGNATORY}}': request.signatory,
        '{{CERTIFICATE_CONTENT}}': getCertificateContent(request.certificate_type)
    };
    
    Object.keys(replacements).forEach(placeholder => {
        const regex = new RegExp(placeholder, 'g');
        content = content.replace(regex, replacements[placeholder]);
    });
    
    return content;
}

// Enhanced getDefaultTemplate function with logo loading
function getDefaultTemplate(request) {
    // Load logos from localStorage
    const barangayLogo = localStorage.getItem('barangayLogo');
    const cityLogo = localStorage.getItem('cityLogo');
    
    // Create logo HTML based on what's available
    const barangayLogoHTML = barangayLogo ? 
        `<img src="${barangayLogo}" alt="Barangay Logo" class="img-fluid" style="max-height: 95px; object-fit: contain;">` :
        `<div class="logo-placeholder" style="width: 95px; height: 95px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #f8f9fa;">
            <span style="font-size: 12px; color: #6c757d; text-align: center;">Barangay<br>Logo</span>
        </div>`;
    
    const cityLogoHTML = cityLogo ? 
        `<img src="${cityLogo}" alt="City Logo" class="img-fluid" style="max-height: 100px; object-fit: contain;">` :
        `<div class="logo-placeholder" style="width: 100px; height: 100px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #f8f9fa;">
            <span style="font-size: 12px; color: #6c757d; text-align: center;">City<br>Logo</span>
        </div>`;

    return `
        <!-- Certificate Header -->
        <div class="text-center mb-4">
            <div class="row align-items-center">
                <div class="col-3">
                    <div class="logo-container" style="display: flex; justify-content: center; align-items: center; height: 120px;">
                        ${barangayLogoHTML}
                    </div>
                </div>
                <div class="col-6">
                    <h6 class="mb-0 editable" contenteditable="false" data-field="header_republic">Republic of the Philippines</h6>
                    <p class="mb-0 editable" contenteditable="false" data-field="header_province">Province of Bukidnon</p>
                    <p class="mb-0 editable" contenteditable="false" data-field="header_city">City of Valencia</p>
                    <h5 class="mb-0 editable" contenteditable="false" data-field="header_barangay">Barangay San Carlos</h5>
                    <p class="mb-0 editable" contenteditable="false" data-field="header_decoration">~ o ~ o ~ O ~ o ~ o ~</p>
                    <h6 class="mb-0 editable" contenteditable="false" data-field="header_office">OFFICE OF THE PUNONG BARANGAY</h6>
                    <br>
                    <h1 class="mt-2 editable" contenteditable="false" data-field="certificate_title">{{CERTIFICATE_TYPE}}</h1>
                </div>
                <div class="col-3">
                    <div class="logo-container" style="display: flex; justify-content: center; align-items: center; height: 120px;">
                        ${cityLogoHTML}
                    </div>
                </div>
            </div>
        </div>
        
        <br><br>
        
        <!-- Certificate Body -->
        <div class="mb-4">
            <p class="mb-2 editable" contenteditable="false" data-field="greeting">TO WHOM IT MAY CONCERN:</p>
            <br>
            <p class="mb-2">
                <span class="ms-5"></span><span class="editable" contenteditable="false" data-field="certify_intro">THIS IS TO CERTIFY that</span> 
                <span class="fw-bold editable" contenteditable="false" data-field="resident_name" data-dynamic="true">{{RESIDENT_NAME}}</span> 
                <span class="editable" contenteditable="false" data-field="certify_middle">has requested a</span> <span class="fw-bold editable" contenteditable="false" data-field="certificate_type_mention" data-dynamic="true">{{CERTIFICATE_TYPE}}</span> <span class="editable" contenteditable="false" data-field="certify_end">from this Office.</span>
            </p>
            <br>
            <p class="mb-2">
                <span class="ms-5"></span><span class="editable" contenteditable="false" data-field="certificate_content" data-dynamic="true">{{CERTIFICATE_CONTENT}}</span>
            </p>
            <br>
            <p class="mb-2">
                <span class="ms-5"></span><span class="editable" contenteditable="false" data-field="purpose_intro">THIS CERTIFICATION is being issued upon the request of the above named-person for:</span> 
                <span class="fw-bold editable" contenteditable="false" data-field="purpose" data-dynamic="true">{{PURPOSE}}</span>
            </p>
            <br>
            <p class="mb-2">
                <span class="editable" contenteditable="false" data-field="issue_intro">Issued this</span> <span class="fw-bold editable" contenteditable="false" data-field="issue_date" data-dynamic="true">{{REQUEST_DATE}}</span> 
                <span class="editable" contenteditable="false" data-field="issue_location">at the office of the Punong Barangay, San Carlos, City of Valencia, Bukidnon.</span>
            </p>
        </div>
        
        <!-- Certificate Footer/Signatures -->
        <br><br><br><br><br>
        
        <div class="row mt-5">
            <div class="col-6">
                <p class=" text-center fw-bold editable" contenteditable="false" data-field="signatory_name" data-dynamic="true">{{SIGNATORY}}</p>
                <p class="text-center editable" contenteditable="false" data-field="signatory_title">Sangguniang Barangay Member</p>
            </div>
            <div class="col-6">
                <p class="mb-0 text-center editable" contenteditable="false" data-field="punong_name">Hon. Mariza T. Labe</p>
                <p class="text-center editable" contenteditable="false" data-field="punong_title">Punong Barangay</p>
            </div>
        </div>
    `;
}

// Enhanced applySavedTemplate function with logo loading
function applySavedTemplate(template, request) {
    let content = template.content;
    
    // Load logos from localStorage
    const barangayLogo = localStorage.getItem('barangayLogo');
    const cityLogo = localStorage.getItem('cityLogo');
    
    // Update logos in saved template if they exist
    if (barangayLogo || cityLogo) {
        content = updateLogosInTemplate(content, barangayLogo, cityLogo);
    }
    
    // Replace dynamic placeholders with actual data
    const replacements = {
        '{{RESIDENT_NAME}}': request.resident_name,
        '{{CERTIFICATE_TYPE}}': request.certificate_type,
        '{{PURPOSE}}': request.purpose,
        '{{REQUEST_DATE}}': formatDate(request.request_date).split('<br>')[0],
        '{{SIGNATORY}}': request.signatory,
        '{{CERTIFICATE_CONTENT}}': getCertificateContent(request.certificate_type)
    };
    
    Object.keys(replacements).forEach(placeholder => {
        const regex = new RegExp(placeholder, 'g');
        content = content.replace(regex, replacements[placeholder]);
    });
    
    return content;
}

// Function to update logos in existing template content
function updateLogosInTemplate(templateContent, barangayLogo, cityLogo) {
    // Create logo HTML based on what's available
    const barangayLogoHTML = barangayLogo ? 
        `<img src="${barangayLogo}" alt="Barangay Logo" class="img-fluid" style="max-height: 95px; object-fit: contain;">` :
        `<div class="logo-placeholder" style="width: 95px; height: 95px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #f8f9fa;">
            <span style="font-size: 12px; color: #6c757d; text-align: center;">Barangay<br>Logo</span>
        </div>`;
    
    const cityLogoHTML = cityLogo ? 
        `<img src="${cityLogo}" alt="City Logo" class="img-fluid" style="max-height: 100px; object-fit: contain;">` :
        `<div class="logo-placeholder" style="width: 100px; height: 100px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #f8f9fa;">
            <span style="font-size: 12px; color: #6c757d; text-align: center;">City<br>Logo</span>
        </div>`;

    // Replace old logo images or placeholders with current ones
    // Pattern for barangay logo (first logo container)
    const barangayLogoPattern = /<div class="col-3">\s*(?:<div class="logo-container"[^>]*>)?\s*(?:<img[^>]*alt="Barangay Logo"[^>]*>|<div class="logo-placeholder"[^>]*>.*?<\/div>)\s*(?:<\/div>)?\s*<\/div>/s;
    
    // Pattern for city logo (last logo container)  
    const cityLogoPattern = /<div class="col-3">\s*(?:<div class="logo-container"[^>]*>)?\s*(?:<img[^>]*alt="City Logo"[^>]*>|<div class="logo-placeholder"[^>]*>.*?<\/div>)\s*(?:<\/div>)?\s*<\/div>(?=\s*<\/div>\s*<\/div>)/s;
    
    // Update barangay logo
    if (barangayLogoPattern.test(templateContent)) {
        templateContent = templateContent.replace(barangayLogoPattern, 
            `<div class="col-3">
                <div class="logo-container" style="display: flex; justify-content: center; align-items: center; height: 120px;">
                    ${barangayLogoHTML}
                </div>
            </div>`
        );
    }
    
    // Update city logo
    if (cityLogoPattern.test(templateContent)) {
        templateContent = templateContent.replace(cityLogoPattern, 
            `<div class="col-3">
                <div class="logo-container" style="display: flex; justify-content: center; align-items: center; height: 120px;">
                    ${cityLogoHTML}
                </div>
            </div>`
        );
    }
    
    // Fallback: If no logo containers found, add them
    if (!templateContent.includes('logo-container')) {
        templateContent = addLogoContainersToTemplate(templateContent, barangayLogoHTML, cityLogoHTML);
    }
    
    return templateContent;
}

// Function to add logo containers to templates that don't have them
function addLogoContainersToTemplate(templateContent, barangayLogoHTML, cityLogoHTML) {
    // Find the header row and update it to include logos
    const headerRowPattern = /<div class="row align-items-center">(.*?)<\/div>/s;
    const headerMatch = templateContent.match(headerRowPattern);
    
    if (headerMatch) {
        const newHeaderRow = `
            <div class="row align-items-center">
                <div class="col-3">
                    <div class="logo-container" style="display: flex; justify-content: center; align-items: center; height: 120px;">
                        ${barangayLogoHTML}
                    </div>
                </div>
                <div class="col-6">
                    ${headerMatch[1].trim()}
                </div>
                <div class="col-3">
                    <div class="logo-container" style="display: flex; justify-content: center; align-items: center; height: 120px;">
                        ${cityLogoHTML}
                    </div>
                </div>
            </div>
        `;
        
        templateContent = templateContent.replace(headerRowPattern, newHeaderRow);
    }
    
    return templateContent;
}

// Enhanced populateCertificate function with logo refresh
function populateCertificate(request) {
    document.getElementById('certificateModalLabel').textContent = request.certificate_type + ' Preview';
    
    const certificatePreview = document.getElementById('certificatePreview');
    const templateKey = getTemplateKey(request.certificate_type);
    
    // Check if we have a saved template for this certificate type
    const savedTemplate = certificateTemplates[templateKey];
    
    let certificateContent;
    
    if (savedTemplate) {
        // Use saved template and replace dynamic data
        certificateContent = applySavedTemplate(savedTemplate, request);
    } else {
        // Use default template
        certificateContent = getDefaultTemplate(request);
    }
    
    certificatePreview.innerHTML = certificateContent;
    
    // Force logo refresh after a short delay to ensure DOM is updated
    setTimeout(() => {
        refreshLogosInCertificate();
    }, 100);
}

// Function to refresh logos in the current certificate view
function refreshLogosInCertificate() {
    const barangayLogo = localStorage.getItem('barangayLogo');
    const cityLogo = localStorage.getItem('cityLogo');
    
    const logoContainers = document.querySelectorAll('.logo-container');
    
    if (logoContainers.length >= 2) {
        // Update barangay logo (first container)
        if (barangayLogo) {
            logoContainers[0].innerHTML = `<img src="${barangayLogo}" alt="Barangay Logo" class="img-fluid" style="max-height: 95px; object-fit: contain;">`;
        } else {
            logoContainers[0].innerHTML = `<div class="logo-placeholder" style="width: 95px; height: 95px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #f8f9fa;">
                <span style="font-size: 12px; color: #6c757d; text-align: center;">Barangay<br>Logo</span>
            </div>`;
        }
        
        // Update city logo (second container)
        if (cityLogo) {
            logoContainers[1].innerHTML = `<img src="${cityLogo}" alt="City Logo" class="img-fluid" style="max-height: 100px; object-fit: contain;">`;
        } else {
            logoContainers[1].innerHTML = `<div class="logo-placeholder" style="width: 100px; height: 100px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #f8f9fa;">
                <span style="font-size: 12px; color: #6c757d; text-align: center;">City<br>Logo</span>
            </div>`;
        }
    }
}

// Enhanced loadSavedTemplates function to handle logo upgrades
function loadSavedTemplates() {
    try {
        const saved = localStorage.getItem('certificateTemplates');
        if (saved) {
            certificateTemplates = JSON.parse(saved);
            // Upgrade existing templates to ensure they have logo containers
            upgradeTemplatesWithLogos();
        }
    } catch (error) {
        console.error('Error loading saved templates:', error);
        certificateTemplates = {};
    }
}

// Function to upgrade existing templates with logo support
function upgradeTemplatesWithLogos() {
    let templatesUpdated = false;
    
    Object.keys(certificateTemplates).forEach(templateKey => {
        const template = certificateTemplates[templateKey];
        
        // Check if template needs logo upgrade
        if (!template.content.includes('logo-container')) {
            const barangayLogo = localStorage.getItem('barangayLogo');
            const cityLogo = localStorage.getItem('cityLogo');
            
            const barangayLogoHTML = barangayLogo ? 
                `<img src="${barangayLogo}" alt="Barangay Logo" class="img-fluid" style="max-height: 95px; object-fit: contain;">` :
                `<div class="logo-placeholder" style="width: 95px; height: 95px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #f8f9fa;">
                    <span style="font-size: 12px; color: #6c757d; text-align: center;">Barangay<br>Logo</span>
                </div>`;
            
            const cityLogoHTML = cityLogo ? 
                `<img src="${cityLogo}" alt="City Logo" class="img-fluid" style="max-height: 100px; object-fit: contain;">` :
                `<div class="logo-placeholder" style="width: 100px; height: 100px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #f8f9fa;">
                    <span style="font-size: 12px; color: #6c757d; text-align: center;">City<br>Logo</span>
                </div>`;
            
            template.content = addLogoContainersToTemplate(template.content, barangayLogoHTML, cityLogoHTML);
            template.lastModified = new Date().toISOString();
            templatesUpdated = true;
        }
    });
    
    // Save updated templates
    if (templatesUpdated) {
        saveTemplatesToStorage();
        console.log('Templates upgraded with logo support');
    }
}

// Function to handle logo updates across all templates
function updateAllTemplatesWithNewLogos() {
    const barangayLogo = localStorage.getItem('barangayLogo');
    const cityLogo = localStorage.getItem('cityLogo');
    
    Object.keys(certificateTemplates).forEach(templateKey => {
        const template = certificateTemplates[templateKey];
        template.content = updateLogosInTemplate(template.content, barangayLogo, cityLogo);
        template.lastModified = new Date().toISOString();
    });
    
    saveTemplatesToStorage();
    
    // Refresh current certificate view if one is open
    if (currentRequestData) {
        populateCertificate(currentRequestData);
    }
}

// Listen for logo changes in localStorage (from other tabs/windows)
window.addEventListener('storage', function(e) {
    if (e.key === 'barangayLogo' || e.key === 'cityLogo') {
        // Logo was updated in another tab, refresh current view
        if (currentRequestData) {
            setTimeout(() => {
                populateCertificate(currentRequestData);
            }, 100);
        }
    }
});

// Enhanced setupEventListeners function
function setupEventListeners() {
    // Edit mode toggle
    document.getElementById('editModeBtn').addEventListener('click', function() {
        isEditMode = true;
        toggleEditMode();
    });

    document.getElementById('saveModeBtn').addEventListener('click', function() {
        isEditMode = false;
        toggleEditMode();
        
        // Save template for this certificate type
        saveCertificateTemplate();
        
        // Show success message
        showSuccessMessage('Changes saved permanently! All future certificates of this type will use your changes.');
    });
}

// Call logo upgrade on page load
document.addEventListener("DOMContentLoaded", function() {
    loadSavedTemplates();
    // ... rest of your existing DOMContentLoaded code
});

// Enhanced toggleEditMode function with template saving
function toggleEditMode() {
    const editables = document.querySelectorAll('.editable');
    const editBtn = document.getElementById('editModeBtn');
    const saveBtn = document.getElementById('saveModeBtn');
    
    if (isEditMode) {
        editables.forEach(el => {
            el.setAttribute('contenteditable', 'true');
            el.style.backgroundColor = '#fff3cd';
            el.style.border = '1px dashed #007bff';
            el.style.padding = '2px 4px';
            el.style.cursor = 'text';
            el.style.borderRadius = '3px';
            
            // Add focus event to highlight current editing element
            el.addEventListener('focus', function() {
                this.style.backgroundColor = '#e7f3ff';
                this.style.border = '2px solid #007bff';
            });
            
            // Add blur event to return to normal edit styling
            el.addEventListener('blur', function() {
                this.style.backgroundColor = '#fff3cd';
                this.style.border = '1px dashed #007bff';
            });
        });
        editBtn.classList.add('d-none');
        saveBtn.classList.remove('d-none');
        
        // Show edit instructions
        showEditInstructions();
    } else {
        editables.forEach(el => {
            el.setAttribute('contenteditable', 'false');
            el.style.backgroundColor = '';
            el.style.border = '';
            el.style.padding = '';
            el.style.cursor = '';
            el.style.borderRadius = '';
            
            // Remove event listeners
            el.removeEventListener('focus', function() {});
            el.removeEventListener('blur', function() {});
        });
        editBtn.classList.remove('d-none');
        saveBtn.classList.add('d-none');
        
        // Hide edit instructions
        hideEditInstructions();
    }
}

// Save certificate template with current changes
function saveCertificateTemplate() {
    if (!currentRequestData) return;
    
    const templateKey = getTemplateKey(currentRequestData.certificate_type);
    const editables = document.querySelectorAll('.editable');
    
    // Create template content with placeholders for dynamic data
    let templateContent = document.getElementById('certificatePreview').innerHTML;
    
    // Replace dynamic content with placeholders
    editables.forEach(el => {
        const field = el.getAttribute('data-field');
        const isDynamic = el.getAttribute('data-dynamic') === 'true';
        const currentText = el.textContent || el.innerText;
        
        if (isDynamic) {
            // Replace with placeholder for dynamic content
            switch(field) {
                case 'resident_name':
                    templateContent = templateContent.replace(currentText, '{{RESIDENT_NAME}}');
                    break;
                case 'certificate_type_mention':
                case 'certificate_title':
                    templateContent = templateContent.replace(currentText, '{{CERTIFICATE_TYPE}}');
                    break;
                case 'purpose':
                    templateContent = templateContent.replace(currentText, '{{PURPOSE}}');
                    break;
                case 'issue_date':
                    templateContent = templateContent.replace(currentText, '{{REQUEST_DATE}}');
                    break;
                case 'signatory_name':
                    templateContent = templateContent.replace(currentText, '{{SIGNATORY}}');
                    break;
                case 'certificate_content':
                    templateContent = templateContent.replace(currentText, '{{CERTIFICATE_CONTENT}}');
                    break;
            }
        }
    });
    
    // Save template
    certificateTemplates[templateKey] = {
        content: templateContent,
        lastModified: new Date().toISOString(),
        certificateType: currentRequestData.certificate_type
    };
    
    // Save to localStorage
    saveTemplatesToStorage();
    
    console.log(`Template saved for ${currentRequestData.certificate_type}`);
}

// Enhanced setupEventListeners function
function setupEventListeners() {
    // Edit mode toggle
    document.getElementById('editModeBtn').addEventListener('click', function() {
        isEditMode = true;
        toggleEditMode();
    });

    document.getElementById('saveModeBtn').addEventListener('click', function() {
        isEditMode = false;
        toggleEditMode();
        
        // Save template for this certificate type
        saveCertificateTemplate();
        
        // Show success message
        showSuccessMessage('Changes saved permanently! All future certificates of this type will use your changes.');
    });
}

// Show edit instructions with template info
function showEditInstructions() {
    const certificatePreview = document.getElementById('certificatePreview');
    
    // Check if instructions already exist
    if (!document.getElementById('editInstructions')) {
        const templateKey = getTemplateKey(currentRequestData.certificate_type);
        const hasTemplate = certificateTemplates[templateKey] ? true : false;
        
        const instructionsDiv = document.createElement('div');
        instructionsDiv.id = 'editInstructions';
        instructionsDiv.className = 'alert alert-info no-print mb-3';
        instructionsDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <div>
                    <strong>Edit Mode Active:</strong> Click on any highlighted text to edit it. 
                    Changes will be saved permanently for all <strong>${currentRequestData.certificate_type}</strong> certificates.
                    <br>
                    <small class="text-muted">
                        ${hasTemplate ? 
                            `<i class="fas fa-check-circle text-success"></i> Custom template exists for this certificate type` : 
                            `<i class="fas fa-info-circle"></i> Using default template - your changes will create a custom template`
                        }
                    </small>
                </div>
            </div>
        `;
        
        // Insert instructions at the top of certificate preview
        certificatePreview.insertBefore(instructionsDiv, certificatePreview.firstChild);
    }
}

// Hide edit instructions
function hideEditInstructions() {
    const instructions = document.getElementById('editInstructions');
    if (instructions) {
        instructions.remove();
    }
}

// Enhanced success message with template info
function showSuccessMessage(message) {
    // Remove existing success message if any
    const existingMessage = document.getElementById('successMessage');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    const templateKey = getTemplateKey(currentRequestData.certificate_type);
    const template = certificateTemplates[templateKey];
    
    const successDiv = document.createElement('div');
    successDiv.id = 'successMessage';
    successDiv.className = 'alert alert-success alert-dismissible fade show no-print';
    successDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <br>
        <small class="text-muted">
            <i class="fas fa-clock me-1"></i>
            Template saved: ${new Date(template.lastModified).toLocaleString()}
        </small>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Insert at the top of the modal body
    const modalBody = document.querySelector('#certificateModal .modal-body');
    modalBody.insertBefore(successDiv, modalBody.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (successDiv) {
            successDiv.remove();
        }
    }, 5000);
}

// Template management functions
function getTemplateList() {
    return Object.keys(certificateTemplates).map(key => ({
        key: key,
        certificateType: certificateTemplates[key].certificateType,
        lastModified: certificateTemplates[key].lastModified
    }));
}

function deleteTemplate(certificateType) {
    const templateKey = getTemplateKey(certificateType);
    if (certificateTemplates[templateKey]) {
        delete certificateTemplates[templateKey];
        saveTemplatesToStorage();
        return true;
    }
    return false;
}

function resetTemplate(certificateType) {
    return deleteTemplate(certificateType);
}

// Initialize templates on page load
document.addEventListener("DOMContentLoaded", function() {
    loadSavedTemplates();
    // ... your existing DOMContentLoaded code
});

// Add template management to the existing refresh function
function refreshData() {
    loadStatistics();
    loadCertificateRequests();
    loadSavedTemplates(); // Reload templates
    showToast('Data and templates refreshed successfully!');
}


</script>

<script>
        // Function to fetch and update notification counts
        function updateNotificationCounts() {
            fetch('get_request_counts.php')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const pendingCount = data.counts.pending || 0;
                        const processingCount = data.counts.processing || 0;
                        const completedToday = data.counts.completed_today || 0;
                        const totalMonth = data.counts.total_month || 0;
                        
                        // Update main notification badge
                        const badge = document.getElementById('request-notification-badge');
                        const miniBadge = document.getElementById('pending-requests-mini-badge');
                        const citizenRequestsLink = document.getElementById('citizen-requests-link');
                        
                        if (pendingCount > 0) {
                            badge.textContent = pendingCount;
                            badge.classList.remove('hidden');
                            miniBadge.textContent = pendingCount;
                            miniBadge.style.display = 'inline-block';
                            citizenRequestsLink.classList.add('new-request-glow');
                        } else {
                            badge.classList.add('hidden');
                            miniBadge.style.display = 'none';
                            citizenRequestsLink.classList.remove('new-request-glow');
                        }
                        
                        // Update stats cards
                        document.getElementById('pending-count').textContent = pendingCount;
                        document.getElementById('processing-count').textContent = processingCount;
                        document.getElementById('completed-today').textContent = completedToday;
                        document.getElementById('total-month').textContent = totalMonth;
                    }
                })
                .catch(error => {
                    console.error('Error fetching notification counts:', error);
                });
        }

        // Function to load recent requests
        function loadRecentRequests() {
            fetch('get_recent_request.php')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const tbody = document.getElementById('requests-tbody');
                        tbody.innerHTML = '';
                        
                        data.requests.forEach(request => {
                            const row = document.createElement('tr');
                            const statusClass = request.status === 'Pending' ? 'bg-warning' : 
                                              request.status === 'Processing' ? 'bg-info' : 'bg-success';
                            
                            row.innerHTML = `
                                <td>${request.request_id}</td>
                                <td>${request.resident_name}</td>
                                <td>${request.certificate_type}</td>
                                <td>${request.purpose}</td>
                                <td><span class="badge ${statusClass}">${request.status}</span></td>
                                <td>${new Date(request.request_date).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="viewRequest('${request.request_id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${request.status === 'Pending' ? 
                                        `<button class="btn btn-sm btn-success ms-1" onclick="processRequest('${request.request_id}')">
                                            <i class="fas fa-play"></i>
                                        </button>` : ''}
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading recent requests:', error);
                });
        }

        // Function to manually refresh notifications
        function refreshNotifications() {
            updateNotificationCounts();
            loadRecentRequests();
        }

        // Function to view request details
        function viewRequest(requestId) {
            // Implement view request functionality
            alert('Viewing request: ' + requestId);
        }

        // Function to process request
        function processRequest(requestId) {
            if (confirm('Start processing this request?')) {
                fetch('update_requests_status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `request_id=${requestId}&status=Processing`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        refreshNotifications();
                        alert('Request status updated to Processing');
                    } else {
                        alert('Error updating request: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating request status');
                });
            }
        }

        // Initialize notifications when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateNotificationCounts();
            loadRecentRequests();
            
            // Update notifications every 30 seconds
            setInterval(updateNotificationCounts, 30000);
        });

        // Handle dropdown toggle
        document.addEventListener('DOMContentLoaded', function() {
            const dropdowns = document.querySelectorAll('.dropdown-toggle');
            dropdowns.forEach(dropdown => {
                dropdown.addEventListener('click', function(e) {
                    e.preventDefault();
                    const dropdownMenu = this.nextElementSibling;
                    dropdownMenu.classList.toggle('show');
                });
            });
        });
    </script>

      <script>
        // Function to set active page indicator
        function setActivePage(pageName) {
            // Remove active class from all sidebar items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to current page
            const activeItem = document.querySelector(`[data-page="${pageName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                
                // If it's a dropdown item, also highlight the parent
                if (activeItem.classList.contains('dropdown-item')) {
                    const parentDropdown = activeItem.closest('.dropdown').querySelector('.dropdown-toggle');
                    if (parentDropdown) {
                        parentDropdown.classList.add('active');
                    }
                }
            }
        }

        // Auto-detect current page based on URL
        function detectCurrentPage() {
            const currentPath = window.location.pathname;
            const fileName = currentPath.split('/').pop().split('.')[0];
            
            // Map file names to page identifiers
            const pageMap = {
                'dashboard': 'dashboard',
                'Barangay_official': 'view-officials',
                'manage_official': 'manage-officials',
                'Residents': 'register-residents',
                'view_residents': 'view-residents',
                'Request_Documents': 'request-documents',
                'Issued Certificate': 'certificate-issuance',
                'Administration': 'administration',
                'Announcement': 'announcements',
                'list_admins': 'system-settings',
                'request_reports': 'reports'
            };
            
            const currentPage = pageMap[fileName];
            if (currentPage) {
                setActivePage(currentPage);
            }
        }

        

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            detectCurrentPage();
            updateNotificationCounts();
            
            // Update notifications every 30 seconds
            setInterval(updateNotificationCounts, 30000);
        });

        // Handle dropdown toggle
        document.addEventListener('DOMContentLoaded', function() {
            const dropdowns = document.querySelectorAll('.dropdown-toggle');
            dropdowns.forEach(dropdown => {
                dropdown.addEventListener('click', function(e) {
                    e.preventDefault();
                    const dropdownMenu = this.nextElementSibling;
                    dropdownMenu.classList.toggle('show');
                });
            });
        });

        // Call this function after a new certificate request is submitted
        function triggerNotificationUpdate() {
            updateNotificationCounts();
        }
    </script>

    <script>
        // Certificate Print Functions
function printCertificate() {
    // Prepare the certificate for printing
    prepareCertificateForPrint();
    
    // Add print button if it doesn't exist
    addPrintButton();
    
    // Trigger print dialog
    window.print();
}

function prepareCertificateForPrint() {
    // Find the modal content
    const modal = document.querySelector('.modal.show');
    if (!modal) {
        console.error('No active modal found');
        return;
    }
    
    // Add certificate-print class to modal body content
    const modalBody = modal.querySelector('.modal-body');
    if (modalBody) {
        modalBody.classList.add('certificate-print');
        
        // Ensure the content has proper structure
        if (!modalBody.querySelector('.certificate-content')) {
            modalBody.classList.add('certificate-content');
        }
    }
    
    // Add print-friendly classes
    modal.classList.add('certificate-modal');
}

function addPrintButton() {
    // Check if print button already exists
    if (document.querySelector('.print-certificate-btn')) {
        return;
    }
    
    // Create print button
    const printBtn = document.createElement('button');
    printBtn.className = 'print-certificate-btn';
    printBtn.innerHTML = '🖨️ Print Certificate';
    printBtn.onclick = printCertificate;
    
    // Add to body
    document.body.appendChild(printBtn);
    
    // Remove button when modal is closed
    const modal = document.querySelector('.modal.show');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            if (printBtn && printBtn.parentNode) {
                printBtn.parentNode.removeChild(printBtn);
            }
        });
    }
}

// Auto-add print button when modal is shown
document.addEventListener('DOMContentLoaded', function() {
    // Listen for modal events
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            // Check if this is a certificate modal (you can adjust this condition)
            if (modal.querySelector('[class*="certificate"]') || 
                modal.textContent.includes('BARANGAY CLEARANCE') ||
                modal.textContent.includes('CLEARANCE')) {
                
                setTimeout(() => {
                    addPrintButton();
                    prepareCertificateForPrint();
                }, 100);
            }
        });
        
        modal.addEventListener('hidden.bs.modal', function() {
            const printBtn = document.querySelector('.print-certificate-btn');
            if (printBtn) {
                printBtn.remove();
            }
        });
    });
});

// Handle print events
window.addEventListener('beforeprint', function() {
    // Ensure proper styling before print
    const modal = document.querySelector('.modal.show');
    if (modal) {
        modal.style.display = 'block';
        modal.style.opacity = '1';
        
        const modalDialog = modal.querySelector('.modal-dialog');
        if (modalDialog) {
            modalDialog.style.transform = 'none';
            modalDialog.style.margin = '0';
        }
    }
});

window.addEventListener('afterprint', function() {
    // Restore normal modal styling after print
    const modal = document.querySelector('.modal.show');
    if (modal) {
        modal.style.display = '';
        modal.style.opacity = '';
        
        const modalDialog = modal.querySelector('.modal-dialog');
        if (modalDialog) {
            modalDialog.style.transform = '';
            modalDialog.style.margin = '';
        }
    }
});

// Keyboard shortcut for printing (Ctrl+P)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'p') {
        const modal = document.querySelector('.modal.show');
        if (modal && (modal.textContent.includes('BARANGAY') || modal.textContent.includes('CLEARANCE'))) {
            e.preventDefault();
            printCertificate();
        }
    }
});
    </script>
</body>
</html>